<!DOCTYPE html>
<html>
  <head>
    <title>scrapjobs</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
    <style>
      .title {
        color: #00dd00;
        text-align: center;
        text-shadow: 0px 3px 8px #ff00ff;
      }

      .kanit-light-italic {
        font-family: "kanit", sans-serif;
        font-weight: 300;
        font-style: italic;
      }

      .kanit-extrabold {
        font-family: "Kanit", sans-serif;
        font-weight: 800;
        font-style: normal;
      }

      form {
        display: flex;
        justify-content: center;
      }

      .search {
        width: 80%;
        background-color: transparent;
        border: 0;
        border-bottom: 1px solid #00cc00;
        color: white;
        padding: 5px;
        font-family: "kanit", sans-serif;
        font-weight: 300;
        font-style: italic;
      }

      .tag {
        border-radius: 4px;
        color: #000;
        background-color: #ddd4ed;
        padding: 3px 11px;
        margin: 3px;
        display: inline-block;
      }


      a {
        color: #fff;
        //text-shadow: 0px 2px 8px #00cc00;
      }

      a:visited {
        color: #544454;
      }

      body {
        background-color: black;
        color: white;
        font-family: "kanit", sans-serif;
        font-weight: 300;
      }

      #output b {
        font-family: "kanit", sans-serif;
        font-weight: 500;
        font-style: italic;
        text-shadow: 0px 2px 6px #ff00ff;
      }
    </style>
  </head>
  <body>
    <h1 class="title kanit-light-italic">scrapjobs</h1>
    <form onsubmit="return false;">
      <input type="text" class="search" id="message" autocomplete="off" placeholder="Search a job" onkeyup="searchKeyPress(event)" onkeypress="searchKeyPressDown(event)">
    </form>
    <hr>
    <div id="output"></div>

    <script>

    const colors = [
      "#FF5733",
      "#33FF57",
      "#7D90E8",

      "#F0F8FF",
      "#FAEBD7",
      "#D2691E",

      "#FF4500",
      "#2E8B57",
      "#FF1493",

      "#1E90FF",
      "#FFD700"
    ];

    const specialTags = {
      "new": "#33FF57"
    };

    async function hashStringToNumber(str) {
      if (str.length < 4) {
        // Hack to avoid short strings to coliding so much
        str = str.repeat(3);
      }
      const encoder = new TextEncoder();
      const data = encoder.encode(str);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

      // Convert the first 8 characters of the hex string to a number
      const hashNumber = parseInt(hashHex.substring(0, 8), 16);
      return hashNumber;
    }

    async function pickColor(tag) {
      if (tag in specialTags) {
        return specialTags[tag];
      }
      const idx = await hashStringToNumber(tag).then(n => n % colors.length);
      return colors[idx];
    }

    let secure = window.location.protocol.includes('https') ? 's':'';
    var socket = new WebSocket("ws"+secure+"://" +
      window.location.host + "/ws/server");

    socket.onopen = function(event) {
      console.log("WebSocket connected!");
    }

    socket.onmessage = async function(event) {
      const results = JSON.parse(event.data);
      if (results === null) {
        document.getElementById("output").innerhtml = `<em>No data!</em>`;
        return;
      };
      console.assert(Array.isArray(results));

      const tag = async (tag) => {
        const color = await pickColor(tag);
        const style = (function(){
          switch (tag) {
          case "new":
            return "box-shadow: 0px 0px 30px #e51bc5;";
          default:
            return "";
          }
        })();
        return `<span class="tag" style="background-color: ${color}; ${style}">${tag}</span>`;
      };

      // Title Tags Url Rank Headline 
      const lis = await Promise.all(results.map(async result => {
        const resultTags = await Promise.all(result.Tags.map(tag)).then(strings => strings.join(""));
        return `<li>
          <a href="${result.Url}" target="_blank" class="kanit-extrabold">${result.Title}</a>
          ${resultTags}
          <pre>${result.Headline}</pre>
        </li>`
      })).then(x => x.join(""));
      const element = document.createElement("div");
      element.innerHTML = `<em>Total</em>: ${results.length}<ul>${lis}</ul>`;
      element.style.display = 'none';
      document.getElementById("output").replaceChildren(element);
      // This is to fix a flickering of the a:visited style blinking
      // after each search.
      setTimeout(() => element.style.display = 'block', 50);
    }

    function throttle(delay, func) {
      let timeout = null;

      return arg => {
        if (!timeout) {
          func(arg);
          timeout=setTimeout(() => { timeout = null }, delay)
        }
      };
    }

    const sendKeyPress = throttle(100, Query => {
     socket.send(JSON.stringify({ Query }))
    });

    function searchKeyPress(e) {
      sendKeyPress(e.target.value);
    }

    function searchKeyPressDown(e) {
      if (e.keyIdentifier=='U+000A' ||
          e.keyIdentifier=='Enter' ||
          e.keyCode==13) {
        e.preventDefault();
        return false;
      }

      return true;
    }

    function sendMessage() {
      var message = document.getElementById("message").value;
      socket.send(JSON.stringify({ Query: message }));
      document.getElementById("message").value = "";
    }
    </script>
  </body>
</html>
